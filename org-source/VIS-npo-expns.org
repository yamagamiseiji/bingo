#+setupfile: /home/yamagami/org/macros-org/org/org-macros.setup
#           Time-stamp: <2024-01-27 16:32:33 yamagami>
#+title: Ledger-cliでNPO法人会計の可視化 --- かんたん折れ線グラフ
#+date: [2024-01-28]
#+language: ja
#+link: file file+sys:../static/
#+hugo_base_dir: ~/peace-blog/bingo/
#+hugo_section: posts
#+hugo_tags: ledger-cli NPO visualization 可視化
#+hugo_categories: comp

#+options: toc:nil
#+draft: false

* イントロ
NPO法人会計で求められているのは財務諸表とその注記までです。
それらは数値とその表、若干の補足文言です。

しかし日々、月々さらには年ごとの経費、収益や資産、負債などの動きを数値と文字の表だけでなくグラフで可視化して確認できれば・・・

ここでは
#+begin_example
経常費用を月ごとに集計して折れ線グラフにする
もっともシンプルな例を紹介します
#+end_example

**Ledger-cli** と他のソフトウエアを組み合わせてグラフやチャートを描く方法はたくさんあります。

この記事では、それらの中で bashのシェルスクリプト内でLedger-cliと **gnuplot** を組み合わせて使う例を紹介しています。gnuplotはヒアドキュメントとしてシェルスクリプト内に組み込んでいます。

この記事中のサンプルを見ながら各自の用途にマッチするように改変すれば、すぐにきれいな図が描けると思います。
  
* 出力サンプル

#+attr_html: :width 65%
#+caption:
#+name: sample-chart
[[file:npo/monthly-expnese-rolling.svg]]

- 図の元になったLedgerデータ( =sample-NPO.ledger= )のサンプルは[[https://bred-in-bingo.netlify.app/npo/sample-NPO.ledger][こちら]]からダウンロードできます。
- Ledger起動時のinit-fileのサンプル( =init-npo.dat= )は [[https://bred-in-bingo.netlify.app/npo/configs/init-npo.dat][こちら]] からダウンロードできます。
- Ledger-cliをインストールして、適当な場所に上のサンプルデータとinit-fileを置き、下のスクリプトを起動すれば上の図が表示されます。

* Codeサンプル
#+begin_src sh
#!/bin/bash
#
#  月ごとの経常経費を折れ線グラフにする
#      $0=expns-linecurve.sh
#
ledger reg 経常費用\
       - f sample-NPO.ledger\
       --init-file ./init-npo.dat\
       --monthly\
       --amount-data\
       --collapse\
       > data-to-plot.dat

# csv化
sed 's/ /,/g' data-to-plot.dat > csv.dat
csv_file="csv.dat"

out_file="monthly-expnese-rolling.pdf"

gnuplot <<EOF
  set terminal pdfcairo transparent enhanced font 'Arial, 12'
  set style data linespoints
  set datafile separator ","
# Y軸設定
  set ylabel 'Amount（千円）' font 'Arial,12'
  set ytics font 'Arial,10'
  # 数値に3桁ごとにカンマ（最大8桁）
  set decimal locale
  set format y "%'4.0f"
  set yrange[0:]
# 時間軸設定
  set timefmt "%Y-%m-%d"
  set xdata time
  set format x "%01m" time
# X軸設定
  set xtics font 'Arial,10'
  set xlabel "月" font 'Arial,12'
# 出力ファイル指定
  set output '$out_file'
# 描出
  plot '$csv_file' \
     using 1:2 w linespoints pt 7 ps 0.5 lw 2 notitle,\
     '' using 1:2:(sprintf("%'d", column(2))) with labels\
        font "Arial,8" offset 0,0.7 textcolor linestyle 0 notitle
  set output
EOF

evince ${out_file}
exit 0
#+end_src


* Appendix:
過去のブログで直接・間接的にLedgerの「可視化」に関連したものは次のとおりです：
- **2021-10-17:** [[https://bred-in-bingo.netlify.app/posts/ledger-pnl-plotting][投資信託の評価損益を「見える化」する]]
- **2020-04-22:** [[https://bred-in-bingo.netlify.app/posts/broken-histogram][Give me a break!]]
- **2020-02-21:** [[https://bred-in-bingo.netlify.app/posts/horizontal-gauge-by-gnuplot/][予算消化率の水平ゲージをledger-cliとgnuplotで描く]]
- **2020-01-31:** [[https://bred-in-bingo.netlify.app/posts/可視化][ぼちぼちですが可視化してます]]
- **2019-07-27:** [[https://bred-in-bingo.netlify.app/posts/6th-step_ledger][プレーンテキストファイルで「複式」家計簿（6）]]


# Local Variables:
# eval: (org-hugo-auto-export-mode)
# End:
